<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real-Time Collaboration Tool</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="wrapper">

    <header class="glass">
      <h1>Real-Time Collaboration Tool</h1>
      <div class="meta">
        <span id="online">Online: 0</span>
        <span id="last">Last Updated: -</span>
      </div>
    </header>

    <main>
      <section class="editor-section glass">
        <textarea id="editor" placeholder="Start typing together..."></textarea>

        <div class="controls">
          <button id="saveBtn">ðŸ’¾ Save</button>
          <span id="saveStatus"></span>
        </div>
      </section>

      <aside class="sidebar glass">
        <div class="userBox">
          <label>Name</label>
          <input id="username" placeholder="Enter your name" />
          <button id="setName">Set</button>
        </div>

        <div class="log">
          <h3>Activity Log</h3>
          <ul id="activity"></ul>
        </div>
      </aside>
    </main>
  </div>

<script>
const WS_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? `ws://${location.hostname}:8000/ws`
  : `wss://${location.hostname}/ws`;

let ws;
let username = 'Anon';
const editor = document.getElementById('editor');
const onlineEl = document.getElementById('online');
const lastEl = document.getElementById('last');
const activity = document.getElementById('activity');
const saveBtn = document.getElementById('saveBtn');
const saveStatus = document.getElementById('saveStatus');

function log(msg){
  const li = document.createElement('li');
  li.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  activity.prepend(li);
}

function connect() {
  ws = new WebSocket(WS_URL);

  ws.addEventListener('open', () => log('Connected'));

  ws.addEventListener('message', (ev) => {
    try{
      const data = JSON.parse(ev.data);

      if(data.type === 'init'){
        editor.value = data.payload.text || '';
        onlineEl.textContent = 'Online: ' + data.payload.online;
        lastEl.textContent = 'Last Updated: ' + (data.payload.last_updated || '-');
        log('Loaded existing document');
      }

      else if(data.type === 'update'){
        editor.value = data.payload.text;
        lastEl.textContent = 'Last Updated: ' + data.payload.last_updated;
        log(data.payload.author + ' updated the document');
      }

      else if(data.type === 'presence'){
        onlineEl.textContent = 'Online: ' + data.payload.online;
      }

    } catch(e){
      console.error('Invalid message', e);
    }
  });

  ws.addEventListener('close', () => {
    log('Disconnected â€” retrying...');
    setTimeout(connect, 1000);
  });
}

let throttled = false;
editor.addEventListener('input', () => {
  if(throttled) return;
  throttled = true;

  if(ws.readyState === WebSocket.OPEN){
    ws.send(JSON.stringify({ 
      type: 'update', 
      payload: { text: editor.value, author: username }
    }));
  }

  setTimeout(() => throttled = false, 250);
});

document.getElementById('setName').addEventListener('click', () => {
  const val = document.getElementById('username').value.trim();
  if(val){
    username = val;
    log('Name set to ' + username);
  }
});

saveBtn.addEventListener('click', async ()=>{
  saveStatus.textContent = 'Saving...';
  try{
    const resp = await fetch('http://localhost:8000/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: editor.value, name: username })
    });
    const json = await resp.json();
    saveStatus.textContent = 'Saved: ' + json.path;
  } catch(e){
    saveStatus.textContent = 'Save failed';
  }

  setTimeout(()=> saveStatus.textContent = '', 3000); 
});

connect();
</script>

</body>
</html>
